<div class="flex flex-col border-8 border-atzicay-border items-center min-h-screen h-screen p-4 overflow-x-hidden"
  style="background-color: var(--color-atzicay-bg)">
  <!-- Logo flotante - Oculto en m√≥viles y tablets -->
  <div class="hidden xl:block">
    <app-floating-logo></app-floating-logo>
  </div>

  <!-- Loading State (authentication or game) -->
  @if (isLoading || loading) {
  <div class="text-center">
    <div class="animate-spin w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-6"></div>
    <div class="space-y-2">
      <div class="h-2 bg-purple-200 rounded-full overflow-hidden">
        <div class="h-full bg-purple-500 rounded-full animate-pulse"></div>
      </div>
      <p class="text-xl font-medium" [style.color]="'var(--color-text-primary)'">
        {{ isLoading ? "Autenticando..." : "Cargando juego..." }}
      </p>
    </div>
  </div>
  }

  <!-- Error State mejorado -->
  @if ((authError || error) && !isLoading && !loading) {
  <div class="text-center max-w-md">
    <div class="bg-red-50 border-2 border-red-200 text-red-800 px-6 py-4 rounded-2xl mb-6 shadow-lg">
      <div class="flex items-center justify-center mb-3">
        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
      </div>
      <p class="font-bold text-lg mb-2">¬°Ups! Algo sali√≥ mal</p>
      <p class="text-sm">{{ authError || error }}</p>
    </div>
    <button (click)="volverAlDashboard()"
      class="px-8 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl hover:from-purple-700 hover:to-purple-800 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
      ‚Üê Volver al Dashboard
    </button>
  </div>
  }

  <!-- Game Content -->
  @if (!isLoading && !authError && !loading && !error) {
  <div class="w-full h-full flex flex-col">
    <!-- Header Gen√©rico -->
    <app-game-header [tituloJuego]="tituloJuego" [descripcionJuego]="descripcionJuego" [vidasRestantes]="vidasRestantes"
      [palabrasCompletadas]="palabrasCompletadas" [totalPalabras]="totalPalabras" [tiempoRestante]="tiempoRestante"
      [porcentajeProgreso]="porcentajeProgreso" [headerExpanded]="headerExpanded" [mobileMenuOpen]="mobileMenuOpen"
      [mostrarVidas]="false" [mostrarTiempo]="true" [mostrarProgreso]="true" [tipoJuego]="'puzzle'"
      (toggleHeader)="toggleHeader()" (toggleMobileMenu)="toggleMobileMenu()"
      (volverAlDashboard)="volverAlDashboard()"></app-game-header>

    <!-- Pista del Puzzle (espec√≠fica para el puzzle) -->
    @if (puzzleConfig?.clue) {
    <div class="w-full max-w-7xl mx-auto mb-6">
      <div
        class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-3xl shadow-2xl border border-yellow-200 overflow-hidden">
        <div class="p-6">
          <button (click)="togglePista()" class="w-full flex items-center justify-center gap-3 focus:outline-none group"
            aria-label="Mostrar/ocultar pista">
            <div
              class="bg-yellow-400 group-hover:bg-yellow-500 rounded-full p-3 transition-colors shadow-lg group-hover:shadow-xl">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white transition-transform duration-300"
                [ngClass]="{ 'rotate-180': mostrarPista }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9.663 17h4.673M12 3v1m6.364-.636l-.707.707M21 12h-1M17.66 18.364l-.707-.707M12 21v-1m-6.364-.636l.707-.707M3 12h1m2.343-5.657l-.707-.707" />
              </svg>
            </div>
            <div class="text-center">
              <h3 class="text-xl font-bold text-yellow-700 mb-1">
                üí° Pista del Rompecabezas
              </h3>
              <p class="text-sm text-yellow-600 font-medium">
                {{ mostrarPista ? "Toca para ocultar" : "Toca para revelar" }}
              </p>
            </div>
          </button>

          @if (mostrarPista) {
          <div class="mt-6 p-4 bg-white/80 rounded-2xl border border-yellow-200 backdrop-blur-sm"
            style="animation: fadeInUp 0.4s ease forwards">
            <div class="flex items-start gap-3">
              <div class="bg-yellow-100 rounded-full p-2 mt-1">
                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-semibold text-yellow-700 mb-1">
                  Pista del Rompecabezas:
                </p>
                <p class="text-lg font-medium text-gray-800 leading-relaxed">
                  {{ puzzleConfig?.clue }}
                </p>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- √Årea principal del juego - Ocupa el resto del espacio -->
    <div class="flex-1 flex justify-center items-center relative w-full">
      <!-- Panel lateral flotante con piezas disponibles -->
      @if (gameStarted && !gameCompleted) {
      <div class="floating-panel" [class.open]="isPanelOpen" [class.mobile-bottom]="isMobileView">
        <div class="panel-toggle" (click)="togglePanel()">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300"
            [class.rotate-180]="!isPanelOpen" [class.rotate-90]="isMobileView && !isPanelOpen" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </div>

        <!-- Header del panel mejorado -->
        <div class="panel-header">
          <h3 class="text-purple-700 font-bold text-center flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z" />
            </svg>
            Piezas disponibles
          </h3>
          <div class="text-center text-sm text-purple-600 mt-2">
            {{ remainingPiecesCount }} piezas restantes
          </div>
        </div>

        <!-- Contenedor de piezas con scroll mejorado -->
        <div class="pieces-container">
          @for (piece of pieces; track piece.id) {
          @if (isInSidebar(piece)) {
          <div class="puzzle-piece sidebar-piece" [style.background-image]="'url(' + puzzleImageUrl + ')'"
            [style]="getPieceStyle(piece)" [class.selected]="selectedPiece?.id === piece.id"
            (click)="onPieceClick(piece)" draggable="true" (dragstart)="onDragStart(piece, $event)"
            (dragend)="onDragEnd($event)"></div>
          }
          }
        </div>
      </div>
      }

 
      <div
        class="relative mx-auto rounded-2xl shadow-2xl overflow-hidden flex items-center justify-center puzzle-board-container"
        [ngClass]="{
    'bg-gradient-to-br from-white/20 to-purple-50/30 backdrop-blur-sm border-2 border-purple-200/50':
      gameStarted,
    'bg-gradient-to-br from-purple-100 to-purple-200 border-2 border-purple-300':
      !gameStarted
  }" [style.width.px]="getBoardSize().width" [style.height.px]="getBoardSize().height">
        <!-- Pantalla de inicio -->
        @if (!gameStarted) {
        <div class="text-center p-4 md:p-8">
          <div class="mb-4 md:mb-8">
            <div
              class="w-24 h-24 md:w-32 md:h-32 mx-auto mb-4 md:mb-6 bg-white rounded-2xl shadow-lg flex items-center justify-center">
              <svg class="w-12 h-12 md:w-16 md:h-16 text-purple-600" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z" />
              </svg>
            </div>
            <h3 class="text-2xl md:text-3xl font-bold text-purple-800 mb-2 md:mb-4">¬°Comencemos!</h3>
            <p class="text-purple-600 text-base md:text-lg mb-6 md:mb-8 max-w-md mx-auto">
              Prep√°rate para resolver un emocionante rompecabezas. ¬°Cada pieza cuenta!
            </p>
          </div>
          <button (click)="startGame()"
            class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white px-6 py-3 md:px-8 md:py-4 rounded-2xl font-bold text-lg md:text-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
            üéÆ Iniciar Rompecabezas
          </button>
        </div>
        }

        <!-- Juego activo -->
        @if (gameStarted) {
        <div class="p-2 md:p-3 flex items-center justify-center w-full h-full">
          <div class="grid relative rounded-xl overflow-hidden bg-white/5 backdrop-blur-sm border border-purple-200/30"
            [style.grid-template-rows]="'repeat(' + rows + ', 1fr)'"
            [style.grid-template-columns]="'repeat(' + cols + ', 1fr)'" [style.width]="getBoardSize().width + 'px'"
            [style.height]="getBoardSize().height + 'px'">
            <!-- Zonas para soltar piezas -->
            @for (row of rowArray; let rowIndex = $index; track $index) {
            @for (col of colArray; let colIndex = $index; track $index) {
            <div class="drop-zone" [class.occupied]="isPieceAt(rowIndex, colIndex)"
              [class.correct]="isPieceCorrect(rowIndex, colIndex)" (dragover)="onDragOver($event)"
              (drop)="onDrop(rowIndex, colIndex, $event)" style="box-sizing: border-box">
              @if (isPieceAt(rowIndex, colIndex)) {
              @for (piece of pieces; track piece.id) {
              @if (piece.inBoard && piece.currentRow === rowIndex && piece.currentCol === colIndex) {
              <div class="piece-in-board" [class.correct]="piece.correctPos"
                [class.selected]="selectedPiece?.id === piece.id"
                [style.background-image]="'url(' + puzzleImageUrl + ')'" [style]="getCurrentPieceStyle(piece)"
                (click)="onPieceClick(piece)" draggable="true" (dragstart)="onDragStart(piece, $event)"
                (dragend)="onDragEnd($event)"></div>
              }
              }
              }
            </div>
            }
            }
          </div>
        </div>
        }

        <!-- Pantalla de victoria -->
        @if (gameCompleted) {
        <div
          class="absolute inset-0 bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-sm flex items-center justify-center">
          <div class="text-center bg-white/90 rounded-3xl p-6 md:p-8 shadow-2xl max-w-md w-[90%]">
            <div class="mb-4 md:mb-6">
              <div
                class="w-16 h-16 md:w-20 md:h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4">
                <svg class="w-8 h-8 md:w-10 md:h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <h3 class="text-2xl md:text-3xl font-bold text-green-700 mb-1 md:mb-2">¬°Felicitaciones!</h3>
              <p class="text-green-600 text-base md:text-lg">¬°Has completado el rompecabezas perfectamente!</p>
            </div>
            <div class="space-y-2 md:space-y-3 mb-4 md:mb-6">
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Tiempo:</span>
                <span class="font-bold text-green-700">{{ formatTime(timeElapsed) }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Piezas:</span>
                <span class="font-bold text-green-700">{{ totalPieces }}/{{ totalPieces }}</span>
              </div>
            </div>
            <button (click)="volverAlDashboard()"
              class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-2 md:py-3 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all duration-200">
              üèÜ Continuar
            </button>
          </div>
        </div>
        }
      </div>

    </div>
  </div>
  }
</div>