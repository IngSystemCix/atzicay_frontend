<div
  class="flex flex-col border-8 border-atzicay-border items-center min-h-screen h-screen p-4 overflow-x-hidden"
  style="background-color: var(--color-atzicay-bg)"
>
  <!-- Estados de autenticaci√≥n y carga -->
  @if (isLoading && !loading) {
  <div class="flex flex-col items-center justify-center min-h-[400px]">
    <div class="relative">
      <div
        class="animate-spin rounded-full h-16 w-16 border-4 border-purple-200"
      ></div>
      <div
        class="animate-spin rounded-full h-16 w-16 border-t-4 border-purple-600 absolute top-0"
      ></div>
    </div>
    <p class="text-purple-600 text-lg mt-4 font-medium">
      Verificando autenticaci√≥n...
    </p>
  </div>
  } @if (authError && !isLoading) {
  <div class="flex flex-col items-center justify-center min-h-[400px]">
    <div
      class="bg-red-50 border-2 border-red-200 text-red-700 px-6 py-4 rounded-xl shadow-lg max-w-md"
    >
      <div class="flex items-center mb-2">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="font-bold">Error de autenticaci√≥n</p>
      </div>
      <p class="text-sm">{{ authError }}</p>
    </div>
  </div>
  } @if (loading && !isLoading) {
  <div class="flex flex-col items-center justify-center min-h-[400px]">
    <div class="relative">
      <div
        class="animate-spin rounded-full h-16 w-16 border-4 border-purple-200"
      ></div>
      <div
        class="animate-spin rounded-full h-16 w-16 border-t-4 border-purple-600 absolute top-0"
      ></div>
    </div>
    <p class="text-purple-600 text-lg mt-4 font-medium">Cargando juego...</p>
  </div>
  } @if (error && !loading && !isLoading) {
  <div class="flex flex-col items-center justify-center min-h-[400px]">
    <div
      class="bg-red-50 border-2 border-red-200 text-red-700 px-6 py-4 rounded-xl shadow-lg max-w-md"
    >
      <div class="flex items-center mb-2">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="font-bold">Error</p>
      </div>
      <p class="text-sm">{{ error }}</p>
    </div>
  </div>
  } @if (!loading && !error && !isLoading && !authError) {
  <div class="w-full max-w-full mx-auto h-full flex flex-col">
    <!-- Header Mejorado -->
    <div class="w-full mb-6 transition-all duration-500 ease-in-out">
      <!-- Header expandido -->
      <div
        *ngIf="headerExpanded"
        class="bg-white/25 rounded-3xl backdrop-blur-xl shadow-2xl border border-white/40 p-8"
        style="
          backdrop-filter: blur(24px);
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        "
      >
        <!-- Fila superior con t√≠tulo y bot√≥n volver -->
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center gap-5">
            <button
              (click)="volverAlDashboard()"
              class="px-8 py-3 bg-atzicay-bg-button text-white rounded-xl hover:from-purple-700 hover:to-purple-800 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200"
            >
              ‚Üê Volver al Dashboard
            </button>
            <div>
              <h1
                class="text-4xl font-black tracking-tight"
                style="color: var(--color-text-primary)"
              >
                üîç {{ title || "Sopa de Letras" }}
              </h1>
              <p
                class="text-xl opacity-90 mt-1"
                style="color: var(--color-text-primary)"
              >
                {{ description || "Encuentra todas las palabras ocultas" }}
              </p>
            </div>
          </div>
          <button
            (click)="toggleHeader()"
            class="bg-white/30 hover:bg-white/50 backdrop-blur-sm rounded-2xl p-3 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
            title="Minimizar header"
          >
            <svg
              class="w-6 h-6"
              style="color: var(--color-text-primary)"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="2.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M5 15l7-7 7 7"
              />
            </svg>
          </button>
        </div>

        <!-- Stats en cards mejoradas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            class="bg-white/30 rounded-3xl p-6 backdrop-blur-sm border border-white/30 shadow-xl transform hover:scale-105 transition-all duration-300"
          >
            <div class="text-center">
              <div
                class="text-3xl font-black mb-2"
                style="color: var(--color-text-primary)"
              >
                {{ wordsFound }}/{{ totalWords }}
              </div>
              <div
                class="text-base opacity-90 font-medium"
                style="color: var(--color-text-primary)"
              >
                Palabras encontradas
              </div>
            </div>
          </div>
          <div
            class="bg-white/30 rounded-3xl p-6 backdrop-blur-sm border border-white/30 shadow-xl transform hover:scale-105 transition-all duration-300"
          >
            <div class="text-center">
              <div
                class="text-3xl font-black mb-2"
                style="color: var(--color-text-primary)"
              >
                {{ formatTime(timeLeft) }}
              </div>
              <div
                class="text-base opacity-90 font-medium"
                style="color: var(--color-text-primary)"
              >
                Tiempo restante
              </div>
            </div>
          </div>
          <div
            class="bg-white/30 rounded-3xl p-6 backdrop-blur-sm border border-white/30 shadow-xl transform hover:scale-105 transition-all duration-300"
          >
            <div class="text-center">
              <div
                class="text-3xl font-black mb-2"
                style="color: var(--color-text-primary)"
              >
                {{ formatTime(originalTimeLimit - timeLeft) }}
              </div>
              <div
                class="text-base opacity-90 font-medium"
                style="color: var(--color-text-primary)"
              >
                Tiempo transcurrido
              </div>
            </div>
          </div>
        </div>

        <!-- Barra de progreso mejorada -->
        <div class="mt-6">
          <div
            class="w-full h-4 bg-white/20 rounded-2xl overflow-hidden backdrop-blur-sm shadow-inner"
          >
            <div
              class="h-full bg-gradient-to-r from-green-400 via-green-500 to-green-600 transition-all duration-500 rounded-2xl shadow-lg"
              [style.width.%]="(wordsFound / totalWords) * 100"
              style="box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.3)"
            ></div>
          </div>
        </div>
      </div>

      <!-- Header minimizado mejorado -->
      <div
        *ngIf="!headerExpanded"
        class="bg-white/20 rounded-2xl backdrop-blur-xl shadow-2xl border border-white/30 px-8 py-5"
        style="backdrop-filter: blur(24px)"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-5">
            <button
              (click)="volverAlDashboard()"
              class="bg-white/40 hover:bg-white/60 backdrop-blur-sm rounded-xl p-3 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
              title="Volver al Dashboard"
            >
              <svg
                class="w-5 h-5 text-black"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="2.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
            </button>
            <h2
              class="text-2xl font-black"
              style="color: var(--color-text-primary)"
            >
              üîç Sopa de Letras
            </h2>
          </div>
          <div class="flex items-center gap-8">
            <span
              class="text-lg font-bold"
              style="color: var(--color-text-primary)"
            >
              {{ wordsFound }}/{{ totalWords }} | {{ formatTime(timeLeft) }}
            </span>
            <button
              (click)="toggleHeader()"
              class="bg-white/30 hover:bg-white/50 backdrop-blur-sm rounded-xl p-3 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
              title="Expandir header"
            >
              <svg
                class="w-5 h-5"
                style="color: var(--color-text-primary)"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="2.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="w-full flex flex-col xl:flex-row gap-6 m-4">
      <div class="w-full xl:w-3/4 flex flex-col">
        <div
          class="bg-white/95 rounded-3xl shadow-2xl p-6 backdrop-blur-sm border border-white/50"
        >
          <div
            class="grid gap-2 p-6 bg-gradient-to-br from-purple-50 via-white to-purple-25 rounded-2xl select-none mx-auto border-3 border-purple-300 shadow-inner"
            [style.grid-template-columns]="
              'repeat(' + gridCols + ', minmax(0, 1fr))'
            "
            [style.aspect-ratio]="'1 / 1'"
            [style.max-width]="'min(80vw, 600px)'"
          >
            @for (row of grid; track $index) { @for (cell of row; track $index)
            {
            <div
              class="flex items-center justify-center border-2 border-purple-200 rounded-xl text-base md:text-lg lg:text-xl font-bold cursor-pointer transition-all duration-300 aspect-square hover:scale-110 hover:shadow-xl transform-gpu"
              [class.bg-green-100]="cell.isFound"
              [class.bg-yellow-200]="selection.includes(cell) && !cell.isFound"
              [class.text-green-700]="cell.isFound"
              [class.text-purple-700]="
                !cell.isFound && !selection.includes(cell)
              "
              [class.text-purple-900]="
                selection.includes(cell) && !cell.isFound
              "
              [class.font-black]="cell.isFound"
              [class.border-green-400]="cell.isFound"
              [class.border-yellow-400]="
                selection.includes(cell) && !cell.isFound
              "
              [class.border-3]="cell.isFound || selection.includes(cell)"
              [class.shadow-lg]="cell.isFound"
              [class.bg-white]="!cell.isFound && !selection.includes(cell)"
              [class.hover:bg-purple-50]="
                !cell.isFound && !selection.includes(cell)
              "
              (mousedown)="onCellMouseDown(cell)"
              (mouseover)="onCellMouseOver(cell)"
              (mouseup)="onCellMouseUp()"
              (mouseleave)="onCellMouseLeave()"
              style="backdrop-filter: blur(2px)"
            >
              {{ cell.letter }}
            </div>
            } }
          </div>
        </div>
      </div>

      <div class="w-full xl:w-1/4">
        <div
          class="bg-white/95 rounded-3xl shadow-2xl p-8 sticky top-4 backdrop-blur-sm border border-white/50"
        >
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-black text-purple-700">
              Palabras a encontrar
            </h3>
            <div
              class="bg-purple-100 text-purple-800 px-4 py-2 rounded-2xl text-base font-bold shadow-md"
            >
              {{ wordsFound }}/{{ totalWords }}
            </div>
          </div>

          <div class="space-y-4 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
            @for (word of words; track word.text) {
            <div
              class="p-5 rounded-2xl text-center transition-all duration-300 border-3 shadow-lg hover:shadow-xl transform hover:scale-105"
              [class.bg-purple-50]="!word.found"
              [class.border-purple-300]="!word.found"
              [class.bg-green-50]="word.found"
              [class.border-green-400]="word.found"
              [class.line-through]="word.found"
              [class.text-green-700]="word.found"
              [class.text-purple-700]="!word.found"
            >
              <div class="font-black text-xl">{{ word.text }}</div>
              <div class="text-sm mt-2 opacity-80">
                <span
                  class="bg-purple-200 text-purple-700 px-3 py-1 rounded-xl font-semibold"
                >
                  {{ word.orientation }}
                </span>
              </div>
              @if (word.found) {
              <div class="text-green-600 mt-3 text-base font-bold">
                ‚úì Encontrada
              </div>
              }
            </div>
            }
          </div>

          <div class="mt-8 pt-6 border-t-3 border-purple-200">
            <div class="space-y-4">
              <div class="flex justify-between items-center text-base">
                <span class="text-purple-700 font-bold">Progreso:</span>
                <span class="font-black text-purple-800 text-lg">
                  {{ ((wordsFound / totalWords) * 100).toFixed(0) }}%
                </span>
              </div>

              <div class="flex justify-between items-center text-base">
                <span class="text-purple-700 font-bold">Tiempo usado:</span>
                <span class="font-black text-purple-800 text-lg">
                  {{ formatTime(347 - timeLeft) }}
                </span>
              </div>

              <div class="flex justify-between items-center text-base">
                <span class="text-purple-700 font-bold">Restantes:</span>
                <span class="font-black text-purple-800 text-lg">
                  {{ totalWords - wordsFound }} palabras
                </span>
              </div>
            </div>

            <div class="mt-6">
              <div
                class="w-full h-3 bg-purple-200 rounded-2xl overflow-hidden shadow-inner"
              >
                <div
                  class="h-full bg-gradient-to-r from-purple-500 via-purple-600 to-purple-700 rounded-2xl transition-all duration-500 shadow-lg"
                  [style.width]="(wordsFound / totalWords) * 100 + '%'"
                  style="box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.3)"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  }
  <!-- Rating Modal -->
  <app-rating-modal
    [isVisible]="mostrarModalRating"
    [gameInstanceId]="gameInstanceId"
    (close)="onRatingModalClose()"
    (rated)="onGameRated()"
  ></app-rating-modal>
</div>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(147, 51, 234, 0.1);
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(147, 51, 234, 0.4);
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(147, 51, 234, 0.6);
  }
</style>
